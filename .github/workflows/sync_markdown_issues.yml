name: Sync Markdown to Issues

on:
  push:
    paths:
      - '**/*.md'  # ç›‘å¬æ‰€æœ‰ Markdown æ–‡ä»¶å˜åŒ–
    branches:
      - main  # åªåœ¨ main åˆ†æ”¯è§¦å‘

jobs:
  sync_issue:
    runs-on: ubuntu-latest

    steps:
      # ğŸš€ æ‹‰å–å®Œæ•´ä»£ç å†å²
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…³é”®ï¼šæ‹‰å–å®Œæ•´å†å²ï¼Œé¿å… SHA ç¼ºå¤±é—®é¢˜

      # ğŸ¯ å®‰è£… GitHub CLI
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      # ğŸ” æ£€æµ‹ Markdown æ–‡ä»¶å†…å®¹å˜åŒ–
      - name: Get changed Markdown files (with content diff check)
        id: changed-files
        run: |
          # è·å–å½“å‰ SHA
          current_sha=${{ github.sha }}
          before_sha=${{ github.event.before }}

          # ğŸ¯ å¤„ç†é¦–æ¬¡æäº¤ã€æ–°åˆ†æ”¯ç­‰ç‰¹æ®Šæƒ…å†µ
          if [[ "$before_sha" == "0000000000000000000000000000000000000000" || -z "$before_sha" ]]; then
            # å¦‚æœ before_sha ä¸ºç©ºï¼Œè¯´æ˜æ˜¯æ–°åˆ†æ”¯æˆ–é¦–æ¬¡æäº¤ï¼Œä½¿ç”¨ä¸Šä¸€æ¬¡æäº¤æ¯”è¾ƒ
            before_sha=$(git rev-parse HEAD~1)
          fi

          # ğŸ”¥ æ£€æŸ¥æ‰€æœ‰å†…å®¹æœ‰å˜åŒ–çš„ .md æ–‡ä»¶
          changed_files=$(git diff --diff-filter=AM --name-only "$before_sha" "$current_sha" | grep '.md' || true)

          # è¾“å‡ºå˜æ›´çš„æ–‡ä»¶
          echo "Detected changed files: $changed_files"
          
          # å°†æ–‡ä»¶åˆ—è¡¨ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
          echo "$changed_files" > changed_files.txt
          echo "changed_files=@changed_files.txt" >> $GITHUB_ENV
        shell: bash

      # âš¡ï¸ åˆ›å»ºæˆ–æ›´æ–° Issue
      - name: Create or Update Issues for Markdown files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¦‚æœæ²¡æœ‰å˜æ›´çš„ Markdown æ–‡ä»¶å°±é€€å‡º
          if [[ ! -f changed_files.txt ]] || [[ ! -s changed_files.txt ]]; then
            echo "ğŸ‰ No markdown file content changed. Exiting."
            exit 0
          fi

          # ç¡®ä¿ auto-sync æ ‡ç­¾å­˜åœ¨
          if ! gh label list | grep -q "auto-sync"; then
            echo "ğŸ·ï¸ Creating auto-sync label..."
            gh label create "auto-sync" --color "0E8A16" --description "è‡ªåŠ¨åŒæ­¥çš„ Markdown æ–‡ä»¶"
          fi

          # è·å–ä»“åº“ä¿¡æ¯
          REPO_OWNER=$(echo $GITHUB_REPOSITORY | cut -d'/' -f1)
          REPO_NAME=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)

          # å¤„ç†æ¯ä¸ªæ–‡ä»¶
          while IFS= read -r file; do
            # è·³è¿‡ç©ºè¡Œ
            [[ -z "$file" ]] && continue
            
            # ç§»é™¤å¼•å·å¹¶å¤„ç†è½¬ä¹‰å­—ç¬¦
            file_path=$(printf '%b' "${file//\"/}")
            echo "Processing file: $file_path"

            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [[ ! -f "$file_path" ]]; then
              echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file_path"
              echo "åŸå§‹æ–‡ä»¶è·¯å¾„: $file"
              continue
            fi

            # æå–æ–‡ä»¶åä½œä¸º Issue æ ‡é¢˜å’Œ Wiki é¡µé¢å
            title="$(basename "$file_path")"
            wiki_title="${title%.md}"  # ç§»é™¤ .md æ‰©å±•å
            content=$(cat "$file_path")

            # ğŸ•µï¸ æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒå Issue
            issue_number=$(gh issue list --label "auto-sync" --state all --search "$title" --json "number" | jq -r '.[0].number // ""')

            if [[ -n "$issue_number" ]]; then
              # âœï¸ å¦‚æœ Issue å·²å­˜åœ¨ï¼Œæ›´æ–°å†…å®¹
              echo "ğŸ”„ Issue #$issue_number already exists. Updating..."
              gh issue edit "$issue_number" --body "$content"
              echo "âœ… å·²æ›´æ–° Issue #$issue_number"
            else
              # âœ¨ åˆ›å»ºæ–°çš„ Issue
              echo "ğŸ†• Creating new issue: $title"
              gh issue create --title "$title" --body "$content" --label "auto-sync"
              echo "âœ¨ åˆ›å»ºäº†æ–°çš„ Issue: $title"
            fi

            # ğŸ“š æ›´æ–° Wiki é¡µé¢
            echo "ğŸ“š Updating Wiki page: $wiki_title"
            
            # æ£€æŸ¥ Wiki é¡µé¢æ˜¯å¦å­˜åœ¨
            if curl -s -o /dev/null -w "%{http_code}" "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/wiki/$wiki_title" | grep -q "200"; then
              # å¦‚æœ Wiki é¡µé¢å­˜åœ¨ï¼Œæ›´æ–°å†…å®¹
              echo "ğŸ”„ Wiki page exists, updating..."
              curl -X PUT \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"content\":\"$(echo "$content" | base64 -w 0)\",\"message\":\"Update $wiki_title from Markdown\"}" \
                "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/wiki/$wiki_title"
              echo "âœ… å·²æ›´æ–° Wiki é¡µé¢: $wiki_title"
            else
              # å¦‚æœ Wiki é¡µé¢ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°é¡µé¢
              echo "ğŸ†• Creating new Wiki page: $wiki_title"
              curl -X PUT \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"content\":\"$(echo "$content" | base64 -w 0)\",\"message\":\"Create $wiki_title from Markdown\"}" \
                "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/wiki/$wiki_title"
              echo "âœ¨ åˆ›å»ºäº†æ–°çš„ Wiki é¡µé¢: $wiki_title"
            fi
          done < changed_files.txt
        shell: bash
