name: Sync Markdown to Issues

on:
  push:
    paths:
      - '**/*.md'  # ç›‘å¬æ‰€æœ‰ Markdown æ–‡ä»¶å˜åŒ–
    branches:
      - main  # åªåœ¨ main åˆ†æ”¯è§¦å‘

jobs:
  sync_issue:
    runs-on: ubuntu-latest

    steps:
      # ðŸš€ æ‹‰å–å®Œæ•´ä»£ç åŽ†å²
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…³é”®ï¼šæ‹‰å–å®Œæ•´åŽ†å²ï¼Œé¿å… SHA ç¼ºå¤±é—®é¢˜

      # ðŸŽ¯ å®‰è£… GitHub CLI
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      # ðŸ” æ£€æµ‹ Markdown æ–‡ä»¶å†…å®¹å˜åŒ–
      - name: Get changed Markdown files (with content diff check)
        id: changed-files
        run: |
          # èŽ·å–å½“å‰ SHA
          current_sha=${{ github.sha }}
          before_sha=${{ github.event.before }}

          # ðŸŽ¯ å¤„ç†é¦–æ¬¡æäº¤ã€æ–°åˆ†æ”¯ç­‰ç‰¹æ®Šæƒ…å†µ
          if [[ "$before_sha" == "0000000000000000000000000000000000000000" || -z "$before_sha" ]]; then
            # å¦‚æžœ before_sha ä¸ºç©ºï¼Œè¯´æ˜Žæ˜¯æ–°åˆ†æ”¯æˆ–é¦–æ¬¡æäº¤ï¼Œä½¿ç”¨ä¸Šä¸€æ¬¡æäº¤æ¯”è¾ƒ
            before_sha=$(git rev-parse HEAD~1)
          fi

          # ðŸ”¥ æ£€æŸ¥æ‰€æœ‰å†…å®¹æœ‰å˜åŒ–çš„ .md æ–‡ä»¶
          changed_files=$(git diff --diff-filter=AM --name-only "$before_sha" "$current_sha" | grep '.md' || true)

          # è¾“å‡ºå˜æ›´çš„æ–‡ä»¶
          echo "Detected changed files: $changed_files"
          
          # å°†æ–‡ä»¶åˆ—è¡¨ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
          echo "$changed_files" > changed_files.txt
          echo "changed_files=@changed_files.txt" >> $GITHUB_ENV
        shell: bash

      # âš¡ï¸ åˆ›å»ºæˆ–æ›´æ–° Issue
      - name: Create or Update Issues for Markdown files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¦‚æžœæ²¡æœ‰å˜æ›´çš„ Markdown æ–‡ä»¶å°±é€€å‡º
          if [[ ! -f changed_files.txt ]] || [[ ! -s changed_files.txt ]]; then
            echo "ðŸŽ‰ No markdown file content changed. Exiting."
            exit 0
          fi

          # ç¡®ä¿ auto-sync æ ‡ç­¾å­˜åœ¨
          if ! gh label list | grep -q "auto-sync"; then
            echo "ðŸ·ï¸ Creating auto-sync label..."
            gh label create "auto-sync" --color "0E8A16" --description "è‡ªåŠ¨åŒæ­¥çš„ Markdown æ–‡ä»¶"
          fi

          # åˆ›å»º Python è§£ç è„šæœ¬
          cat > decode_path.py << 'EOF'
          import sys
          import re

          def decode_escaped_string(s):
              # ç§»é™¤å¼•å·
              s = s.strip('"')
              
              # åˆ†å‰²å­—ç¬¦ä¸²ä¸ºè½¬ä¹‰å’Œéžè½¬ä¹‰éƒ¨åˆ†
              parts = []
              current = 0
              
              while current < len(s):
                  if s[current] == '\\':
                      # æ‰¾åˆ°è½¬ä¹‰åºåˆ—
                      hex_str = s[current+1:current+4]
                      if len(hex_str) == 3 and all(c in '0123456789abcdefABCDEF' for c in hex_str):
                          # å°†åå…­è¿›åˆ¶è½¬æ¢ä¸ºå­—èŠ‚
                          byte = bytes.fromhex(hex_str)
                          # å°†å­—èŠ‚è§£ç ä¸º UTF-8 å­—ç¬¦
                          parts.append(byte.decode('utf-8'))
                          current += 4
                      else:
                          # å¦‚æžœä¸æ˜¯æœ‰æ•ˆçš„è½¬ä¹‰åºåˆ—ï¼Œä¿ç•™åŽŸæ ·
                          parts.append(s[current])
                          current += 1
                  else:
                      # éžè½¬ä¹‰å­—ç¬¦
                      parts.append(s[current])
                      current += 1
              
              return ''.join(parts)

          for line in sys.stdin:
              line = line.strip()
              if line:
                  try:
                      decoded = decode_escaped_string(line)
                      print(decoded)
                  except Exception as e:
                      print(f"Error decoding {line}: {e}", file=sys.stderr)
                      print(line)
          EOF

          # å¤„ç†æ¯ä¸ªæ–‡ä»¶
          while IFS= read -r file; do
            # è·³è¿‡ç©ºè¡Œ
            [[ -z "$file" ]] && continue
            
            # ä½¿ç”¨ Python è„šæœ¬è§£ç æ–‡ä»¶è·¯å¾„
            file_path=$(echo "$file" | python3 decode_path.py)
            echo "Processing file: $file_path"

            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [[ ! -f "$file_path" ]]; then
              echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file_path"
              echo "åŽŸå§‹æ–‡ä»¶è·¯å¾„: $file"
              echo "è§£ç åŽçš„è·¯å¾„: $file_path"
              continue
            fi

            # æå–æ–‡ä»¶åä½œä¸º Issue æ ‡é¢˜
            title="$(basename "$file_path")"
            content=$(cat "$file_path")

            # ðŸ•µï¸ æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒå Issue
            issue_number=$(gh issue list --label "auto-sync" --state all --search "$title" --json "number" | jq -r '.[0].number // ""')

            if [[ -n "$issue_number" ]]; then
              # âœï¸ å¦‚æžœ Issue å·²å­˜åœ¨ï¼Œæ›´æ–°å†…å®¹
              echo "ðŸ”„ Issue #$issue_number already exists. Updating..."
              gh issue edit "$issue_number" --body "$content"
              echo "âœ… å·²æ›´æ–° Issue #$issue_number"
            else
              # âœ¨ åˆ›å»ºæ–°çš„ Issue
              echo "ðŸ†• Creating new issue: $title"
              gh issue create --title "$title" --body "$content" --label "auto-sync"
              echo "âœ¨ åˆ›å»ºäº†æ–°çš„ Issue: $title"
            fi
          done < changed_files.txt
        shell: bash
