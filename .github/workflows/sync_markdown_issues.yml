name: Sync Markdown to Issue

on:
  push:
    paths:
      - '**/*.md'  # ç›‘å¬æ‰€æœ‰ Markdown æ–‡ä»¶å˜åŒ–
    branches:
      - main  # åªåœ¨ main åˆ†æ”¯è§¦å‘ï¼Œä½ å¯ä»¥æ”¹æˆå…¶ä»–åˆ†æ”¯

jobs:
  sync_issue:
    runs-on: ubuntu-latest

    steps:
      # ğŸš€ æ‹‰å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ¯ å®‰è£… GitHub CLI
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      # ğŸ” æ£€æµ‹å˜æ›´çš„ Markdown æ–‡ä»¶
      - name: Get changed Markdown files
        id: changed-files
        run: |
          changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '.md' || true)
          echo "changed_files=${changed_files}" >> $GITHUB_ENV
        shell: bash

      # âš¡ï¸ å¤„ç†æ¯ä¸ªå˜æ›´çš„ Markdown æ–‡ä»¶
      - name: Create or Update Issues for Markdown files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¦‚æœæ²¡æœ‰å˜æ›´çš„ Markdown æ–‡ä»¶å°±é€€å‡º
          if [[ -z "$changed_files" ]]; then
            echo "ğŸ‰ No markdown files changed. Exiting."
            exit 0
          fi

          # éå†æ¯ä¸ªå˜æ›´çš„ .md æ–‡ä»¶
          for file in $changed_files; do
            # æå–æ–‡ä»¶åä½œä¸º Issue æ ‡é¢˜
            title="ğŸ“„ $(basename "$file") æ›´æ–°äº†"
            content=$(cat "$file")

            # ğŸ•µï¸ æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒå Issue
            issue_number=$(gh issue list --state open --search "$title" --json number --jq '.[0].number')

            if [[ -n "$issue_number" ]]; then
              # âœï¸ å¦‚æœ Issue å·²å­˜åœ¨ï¼Œæ›´æ–°å†…å®¹
              echo "ğŸ”„ Issue #$issue_number already exists. Updating..."
              gh issue edit "$issue_number" --body "$content"
              echo "âœ… å·²æ›´æ–° Issue #$issue_number"
            else
              # âœ¨ åˆ›å»ºæ–°çš„ Issue
              echo "ğŸ†• Creating new issue: $title"
              gh issue create --title "$title" --body "$content" --label "auto-sync"
              echo "âœ¨ åˆ›å»ºäº†æ–°çš„ Issue: $title"
            fi
          done
        shell: bash
